function esdensity(model,h,H)
    ρ0 = 5.25*1e-7
    ρ = ρ0*exp(-(h)/H)
    return ρ
end

function esdensity_spline(model,h)#::T) where T
   h = h / 1000

   # print(h)

   #mean coefficients taken from spline where breaks are breaks = [10:5:60,62:2.:70,71:1.:120];
   coeff_a = [-1.92328741603145e-06
               5.70233021940267e-07
               -9.17634382734206e-07
               1.67046258151837e-07
               -9.60410379784292e-08
               -1.81809912234820e-07
               5.11537551403809e-08
               -6.81539714546325e-08
               1.80097174994589e-08
               -5.05516359272255e-08
               1.38531963939899e-07
               -1.83695690335794e-07
               7.13797067291749e-08
               -2.16631049351496e-08
               9.23302684147096e-08
               -5.89008290453308e-07
               4.98544463788549e-07
               7.40865309407130e-08
               -2.71018743353236e-07
               9.31948854820336e-08
               1.64797562968432e-07
               -1.07482645644253e-07
               -8.49300539147749e-09
               6.15462595873603e-09
               -2.18873639382704e-08
               -1.16441154512268e-08
               -5.75636723797975e-09
               2.05888710662881e-08
               1.05612819522476e-09
               -1.64251652604314e-08
               6.45502558359313e-10
               1.08075846320204e-08
               4.40599598450801e-09
               5.33820713489058e-09
               -1.13138875343691e-09
               -1.11764466787285e-08
               -3.75714873386387e-09
               7.43674333277705e-09
               -3.72271651350473e-09
               2.57269134125480e-10
               -7.26069727181459e-09
               2.23737679537661e-09
               9.79234163687156e-09
               -7.20616671467939e-09
               -3.30938137344359e-09
               6.24497992365985e-09
               -2.54844100784435e-09
               -1.18517353969706e-09
               3.01282134446159e-09
               -1.70146102118281e-09
               -3.96117357150445e-10
               1.02809818331298e-10
               4.34515119912689e-10
               -8.70467948013050e-10
               4.76671477029097e-10
               4.81392756075857e-10
               -7.35781440946678e-10
               6.27706734918959e-10
               -1.04925183199405e-10
               -5.13921202665040e-10
               8.91815914556842e-12
               1.76987380763810e-10
               2.32085782723335e-11
               -2.70136194157839e-11
                  8.50068840616483e-11]
    coeff_b = [3.63834917838628e-05
              7.53418054339119e-06
              1.60876758724952e-05
              2.32316013148208e-06
              4.82885400375964e-06
              3.38823843408320e-06
              6.61089750560905e-07
              1.42839607766662e-06
              4.06086505847134e-07
              6.76232268339018e-07
              -8.20422705693636e-08
              7.49149513070029e-07
              -3.53024628944734e-07
              7.52536114303157e-08
              -5.47250181805823e-08
              4.99256592307676e-07
              -1.26776827905225e-06
              2.27865112313400e-07
              4.50124705135538e-07
              -3.62931524924171e-07
              -8.33468684780695e-08
              4.11045820427227e-07
              8.85978834944662e-08
              6.31188673200334e-08
              8.15827451962414e-08
              1.59206533814306e-08
              -1.90116929722503e-08
              -3.62807946861896e-08
              2.54858185126746e-08
              2.86542030983488e-08
              -2.06212926829454e-08
              -1.86847850078676e-08
              1.37379688881936e-08
              2.69559568417176e-08
              4.29705782463893e-08
              3.95764119860785e-08
              6.04707194989297e-09
              -5.22437425169862e-09
              1.70858557466325e-08
              5.91770620611833e-09
              6.68951360849474e-09
              -1.50925782069490e-08
              -8.38044782081920e-09
              2.09965770897955e-08
              -6.21923054242695e-10
              -1.05500671745735e-08
              8.18487259640609e-09
              5.39549572873028e-10
              -3.01597104621815e-09
              6.02249298716664e-09
              9.18109923618209e-10
              -2.70242147833126e-10
              3.81873071607671e-11
              1.34173266689883e-09
              -1.26967117714032e-09
              1.60343253946976e-10
              1.60452152217455e-09
              -6.02822800665489e-10
              1.28029740409139e-09
              9.65521854493172e-10
              -5.76241753501948e-10
              -5.49487276065244e-10
              -1.85251337738150e-11
              5.11006010431853e-11
              -2.99402572041671e-11]
       coeff_c = [-0.000557324802363520
                  -0.000337736440727249
                  -0.000219627158647817
                  -0.000127572978627931
                  -9.18129079517223e-05
                  -5.07274457625080e-05
                  -3.04808048392875e-05
                  -2.00333756981498e-05
                  -1.08609627805811e-05
                  -5.44936890965032e-06
                  -2.47841892080205e-06
                  -1.14420443580072e-06
                  -3.51954667550125e-07
                  -9.07496702578961e-07
                  -8.66439516079492e-07
                  2.26236321746961e-08
                  -7.45888054569875e-07
                  -1.78579122130872e-06
                  -1.10780140385978e-06
                  -1.02060822364841e-06
                  -1.46688661705065e-06
                  -1.13918766510150e-06
                  -6.39543961179805e-07
                  -4.87827210365305e-07
                  -3.43125597849030e-07
                  -2.45622199271358e-07
                  -2.48713238862178e-07
                  -3.04005726520618e-07
                  -3.14800702694133e-07
                  -2.60660681083110e-07
                  -2.52627770667706e-07
                  -2.91933848358519e-07
                  -2.96880664478193e-07
                  -2.56186738748282e-07
                  -1.86260203660175e-07
                  -1.03713213427707e-07
                  -5.80897294917358e-08
                  -5.72670317935414e-08
                  -4.54055502986075e-08
                  -2.24019883458567e-08
                  -9.79476853124359e-09
                  -1.81978331296979e-08
                  -4.16708591574661e-08
                  -2.90547298884899e-08
                  -8.68007585293709e-09
                  -1.98520660817533e-08
                  -2.22172606599206e-08
                  -1.34928384906415e-08
                  -1.59692599639867e-08
                  -1.29627380230382e-08
                  -6.02213511225332e-09
                  -5.37426733646823e-09
                  -5.60632217714059e-09
                  -4.22640220308099e-09
                  -4.15434071332248e-09
                  -5.26366863651582e-09
                  -3.49880386039430e-09
                  -2.49710513888524e-09
                  -1.81963053545934e-09
                  4.26188723125220e-10
                  8.15468824116444e-10
                  -3.10260205450748e-10
                  -8.78272615289807e-10
                  -8.45697148020437e-10
                  -8.24536804181419e-10]
    coeff_d = [0.00574028413295644
               0.00362283648873149
               0.00219378792642255
               0.00138313973215407
               0.000824234624570449
               0.000473886305158525
               0.000282228798168712
               0.000152746237128845
               7.97700141479325e-05
               3.78685775786379e-05
               2.12085852479586e-05
               1.70318340355962e-05
               1.62704576935885e-05
               1.47254874965428e-05
               1.30382036976249e-05
               1.18250667400613e-05
               1.17579386740903e-05
               1.02428268042568e-05
               8.75898722620216e-06
               7.83029178412468e-06
               6.53994692103413e-06
               5.15451099847383e-06
               4.31888650815531e-06
               3.75944742507849e-06
               3.34089370799196e-06
               3.05746349140090e-06
               2.81611783005974e-06
               2.54263653098734e-06
               2.22293888084682e-06
               1.93468012486058e-06
               1.68624848161539e-06
               1.41364492082310e-06
               1.11383387208873e-06
               8.35097172483240e-07
               6.11204597711566e-07
               4.66783583544344e-07
               3.91470335423986e-07
               3.35670529148280e-07
               2.80615866435817e-07
               2.48573455370337e-07
               2.32346442364724e-07
               2.21980490170161e-07
               1.90927455628890e-07
               1.50668490287477e-07
               1.35404170774103e-07
               1.22792790493479e-07
               9.86356371608125e-08
               8.20548080894536e-08
               6.79163456319880e-08
               5.19439359662448e-08
               4.33022299091905e-08
               3.78020873634049e-08
               3.22603876974349e-08
               2.71267679473677e-08
               2.33716304631725e-08
               1.84242900497388e-08
               1.38023574232458e-08
               1.11722936440794e-08
               8.70007243944765e-09
               8.05581412488029e-09
               8.93360349983364e-09
               9.18174872959370e-09
               8.49898862884152e-09
               7.62539945805023e-09
               6.80378929165720e-09]

    breaks = [10:5:60; 62:2.:70; 71:1.:120]
    # show(breaks)
    if h >=120
        h = 119.9999
    elseif h < 10
        h = 10
    end
    # show(length(breaks))
    for jj in range(0, length(breaks)-1)
        if (h < breaks[jj+1] && h >= breaks[jj])
            # show(jj)
            return coeff_d[jj] + coeff_c[jj]*(h-breaks[jj]) +coeff_b[jj]*(h-breaks[jj])^2 +coeff_a[jj]*(h-breaks[jj])^3
        end
    end
end


function esdynamics(ev::CPEGWorkspace, x::SVector{8,T}, u::SVector{1,W}) where {T,W}
    # scaled variables
    r_scaled = x[SA[1,2,3]]
    v_scaled = x[SA[4,5,6]]
    σ = x[7]
    kρ = x[8]

    # unscale
    r, v = unscale_rv(ev.scale,r_scaled,v_scaled)
    # altitude
    h = altitude(ev.params.gravity, r)[1]
    # density
    # ρ = density(ev.params.density, h)
    ρ = esdensity_spline(ev,h)*(1+kρ)#esdensity(ev, h, 7.295*1e3)*(1+kρ)

    # lift and drag magnitudes
    L, D = LD_mags(ev.params.aero,ρ,r,v)


    # basis for e frame
    e1, e2 = e_frame(r,v)

    # drag and lift accelerations
    D_a = -(D/norm(v))*v
    L_a = L*sin(σ)*e1 + L*cos(σ)*e2

    # gravity
    g = gravity(ev.params.gravity,r)

    # acceleration
    ω = ev.planet.ω
    a = D_a + L_a + g - 2*cross(ω,v) - cross(ω,cross(ω,r))
    # println("alt ",h)
    # rescale units
    v,a = scale_va(ev.scale,v,a)

    return SA[v[1],v[2],v[3],a[1],a[2],a[3],u[1]*ev.scale.uscale,0]
end

function rk4_est(
    ev::CPEGWorkspace,
    x_n::SVector{8,T},
    u::SVector{1,W},
    dt_s::Float64) where {T,W}

    k1 = dt_s*esdynamics(ev,x_n,u)
    k2 = dt_s*esdynamics(ev,x_n+k1/2,u)
    k3 = dt_s*esdynamics(ev,x_n+k2/2,u)
    k4 = dt_s*esdynamics(ev,x_n+k3,u)
    return (x_n + (1/6)*(k1 + 2*k2 + 2*k3 + k4))
end

function get_discdyn(model,X,U,dt)
    # dt_s = dt/ev.scale.tscale
    A= ForwardDiff.jacobian(_x -> rk4(model,_x,U,dt),X)
    B= ForwardDiff.jacobian(_u -> rk4(model,X,_u,dt),U)
    return A,B
end
