using BenchmarkTools

struct density_spline_parameters{T}
    coeff_a::Vector{T}
    coeff_b::Vector{T}
    coeff_c::Vector{T}
    coeff_d::Vector{T}
    breaks::Vector{T}
    function density_spline_parameters()
        new{Float64}([-1.85730963217633e-06
                     5.63671194166011e-07
                     -9.23854326127944e-07
                     1.81373774887554e-07
                     -1.06114739964355e-07
                     -1.76851603918793e-07
                     5.11294589789323e-08
                     -6.90105898557052e-08
                     1.92076685119273e-08
                     -5.20516720253663e-08
                     1.46602318132720e-07
                     -1.96583893102288e-07
                     8.32868772635157e-08
                     -2.70293760024797e-08
                     9.88876925185573e-08
                     -6.77540403855885e-07
                     6.83574806302507e-07
                     -8.79679323492162e-08
                     -2.20656877796438e-07
                     1.13309216591852e-07
                     1.61216545192674e-07
                     -1.45082831650365e-07
                     3.60361278137278e-08
                     -2.77620653994685e-08
                     2.08113190188334e-09
                     -3.03450155831708e-08
                     1.02620035127127e-08
                     1.11332754570756e-08
                     6.94346769244075e-09
                     -2.45386822474158e-08
                     9.76913967884423e-09
                     4.81039642030914e-09
                     8.43988718699577e-09
                     2.22576077622844e-09
                     7.12942864748372e-10
                     -1.41430005990776e-08
                     -7.65579322266507e-10
                     7.13048327827783e-09
                     -5.43753134977055e-09
                     2.60487842848216e-09
                     -1.05242604464062e-08
                     6.04203045827173e-09
                     8.18381527352796e-09
                     -8.36460121687679e-09
                     -2.12089892738481e-09
                     6.90993114342309e-09
                     -4.37117605828736e-09
                     3.35426852280265e-10
                     2.55707740092969e-09
                     -2.10175731616554e-09
                     1.65568885533589e-10
                     -3.48016491726963e-10
                     9.30130013034231e-10
                     -1.52554498638333e-09
                     1.21651990319952e-09
                     -9.24688555784992e-11
                     -4.76650182144385e-10
                     6.24889193126397e-10
                     -1.89958888138123e-10
                     -5.24452837320624e-10
                     1.00214148452797e-10
                     1.13947453046397e-10
                     8.04637497102590e-11
                     -1.33754407803436e-10
                     3.38632561519288e-10
                     0],[3.54484471476105e-05
                 7.58880266496562e-06
                 1.60438705774558e-05
                 2.18605568553662e-06
                 4.90666230884993e-06
                 3.31494120938461e-06
                 6.62167150602710e-07
                 1.42910903528669e-06
                 3.93950187451117e-07
                 6.82065215130026e-07
                 -9.87098652504667e-08
                 7.80904043545853e-07
                 -3.98599315067877e-07
                 1.01121948513218e-07
                 -6.10543075016612e-08
                 5.32271847609683e-07
                 -1.50034936395797e-06
                 5.50375054949550e-07
                 2.86471257901901e-07
                 -3.75499375487414e-07
                 -3.55717257118584e-08
                 4.48077909866164e-07
                 1.28294149150701e-08
                 1.20937798356253e-07
                 3.76516021578478e-08
                 4.38949978634978e-08
                 -4.71400488860146e-08
                 -1.63540383478765e-08
                 1.70457880233504e-08
                 3.78761911006726e-08
                 -3.57398556415749e-08
                 -6.43243660504225e-09
                 7.99875265588512e-09
                 3.33184142168724e-08
                 3.99956965455577e-08
                 4.21345251398028e-08
                 -2.94476657430090e-10
                 -2.59121462422962e-09
                 1.88002352106039e-08
                 2.48764116129220e-09
                 1.03022764467387e-08
                 -2.12705048924800e-08
                 -3.14441351766479e-09
                 2.14070323029191e-08
                 -3.68677134771131e-09
                 -1.00494681298658e-08
                 1.06803253004035e-08
                 -2.43320287445860e-09
                 -1.42692231761780e-09
                 6.24430988517127e-09
                 -6.09620633253436e-11
                 4.35744593275423e-10
                 -6.08304881905466e-10
                 2.18208515719723e-09
                 -2.39454980195277e-09
                 1.25500990764578e-09
                 9.77603340910279e-10
                 -4.52347205522876e-10
                 1.42232037385632e-09
                 8.52443709441947e-10
                 -7.20914802519925e-10
                 -4.20272357161534e-10
                 -7.84299980223429e-11
                 1.62961251108434e-10
                 -2.38301972301875e-10
                 0],[-0.000551292656877884
                 -0.000336106407815003
                 -0.000217943041602896
                 -0.000126793410287934
                 -9.13298203160016e-05
                 -5.02218027248289e-05
                 -3.03362609248923e-05
                 -1.98798799954453e-05
                 -1.07645838817563e-05
                 -5.38450686885056e-06
                 -2.46773011945276e-06
                 -1.10334176286199e-06
                 -3.38732305906035e-07
                 -9.33687039015353e-07
                 -8.53551756992239e-07
                 8.88833232238064e-08
                 -8.79194193124482e-07
                 -1.82916850213290e-06
                 -9.92322189281454e-07
                 -1.08135030686697e-06
                 -1.49242140806624e-06
                 -1.07991522391193e-06
                 -6.19007899130699e-07
                 -4.85240685859376e-07
                 -3.26651285345275e-07
                 -2.45104685323929e-07
                 -2.48349736346446e-07
                 -3.11843823580337e-07
                 -3.11152073904863e-07
                 -2.56230094780840e-07
                 -2.54093759321742e-07
                 -2.96266051568360e-07
                 -2.94699735517517e-07
                 -2.53382568644759e-07
                 -1.80068457882329e-07
                 -9.79382361969685e-08
                 -5.60981877145958e-08
                 -5.89838789962555e-08
                 -4.27748584098813e-08
                 -2.14869820379852e-08
                 -8.69706442995435e-09
                 -1.96652928756957e-08
                 -4.40802112858405e-08
                 -2.58175925005862e-08
                 -8.09733154537843e-09
                 -2.18335710229555e-08
                 -2.12027138524177e-08
                 -1.29555914264728e-08
                 -1.68157166185492e-08
                 -1.19983290509958e-08
                 -5.81498122914986e-09
                 -5.44019869919978e-09
                 -5.61275898782982e-09
                 -4.03897871253806e-09
                 -4.25144335729360e-09
                 -5.39098325160060e-09
                 -3.15837000304454e-09
                 -2.63311386765714e-09
                 -1.66314069932370e-09
                 6.11623383974567e-10
                 7.43152290896589e-10
                 -3.98034868784870e-10
                 -8.96737223968747e-10
                 -8.12205970882656e-10
                 -8.87546692076097e-10
                 0],[0.00570116219576596
                 0.00359874638604477
                 0.00217839331286464
                 0.00137429307852056
                 0.000817649141080248
                 0.000470402254725944
                 0.000280060320846566
                 0.000151324377359538
                 7.90263795325156e-05
                 3.74531733740031e-05
                 2.10758104048302e-05
                 1.69183292499845e-05
                 1.62625907536257e-05
                 1.46570238996502e-05
                 1.29779026076526e-05
                 1.18176834038099e-05
                 1.17612981707875e-05
                 1.00653294200076e-05
                 8.69856804047498e-06
                 7.77206023129899e-06
                 6.42851976553646e-06
                 5.06174317695104e-06
                 4.28482303125491e-06
                 3.71468067485300e-06
                 3.32261572195041e-06
                 3.03569717066487e-06
                 2.80414246762127e-06
                 2.51891468590152e-06
                 2.20185009943038e-06
                 1.91468728124131e-06
                 1.67179469531373e-06
                 1.39173022002925e-06
                 1.09384212827616e-06
                 8.15581032601525e-07
                 5.97742638949866e-07
                 4.58382820477843e-07
                 3.88436108821600e-07
                 3.31277865127308e-07
                 2.76833254785100e-07
                 2.47421100236052e-07
                 2.31026637787841e-07
                 2.22107589358220e-07
                 1.87213822048316e-07
                 1.48173012518338e-07
                 1.35397851103794e-07
                 1.21492849283320e-07
                 9.65197412739216e-08
                 8.16261766636200e-08
                 6.65728092149688e-08
                 5.08872476797315e-08
                 4.30314711977414e-08
                 3.73210967907998e-08
                 3.19686261931485e-08
                 2.66776923364475e-08
                 2.32952537947233e-08
                 1.78657805386764e-08
                 1.36373383391431e-08
                 1.09799214948645e-08
                 8.51934961481086e-09
                 8.08857040120535e-09
                 9.02818465730124e-09
                 9.15063629413070e-09
                 8.44627652123069e-09
                 7.55157304894986e-09
                 6.76857392137221e-09
                 0], [10:5:60; 62:2.:70; 71:1.:120])
             end
end



function density_spline2(dsp::density_spline_parameters, h::T) where T
   h = h / 1000

    if h >= 120
        h = one(h)*119.99
    elseif h < 10
        h = one(h)*10.0
    end
    for jj = 1:(length(dsp.breaks)-1)
        if (h < dsp.breaks[jj+1] && h >= dsp.breaks[jj])
            ρ = dsp.coeff_d[jj] + dsp.coeff_c[jj]*(h-dsp.breaks[jj]) +dsp.coeff_b[jj]*(h-dsp.breaks[jj])^2 +dsp.coeff_a[jj]*(h-dsp.breaks[jj])^3
            return ρ
        end
    end
end

# let
#
#     # let's run some MPC
#     ev = cp.CPEGWorkspace()
#
#     # vehicle parameters
#     ev.params.aero.Cl = 0.29740410453983374
#     ev.params.aero.Cd = 1.5284942035954776
#     ev.params.aero.A = 15.904312808798327    # m²
#     ev.params.aero.m = 2400.0                # kg
#
#     # sim stuff
#     ev.dt = 2.0 # seconds
#
#     # CPEG settings
#     ev.scale.uscale = 1e1
#
#     # cp.density_spline(ev., 50e3)
#     # @btime cp.density_spline($ev.params.density, 50e3)
#     # @btime cp.density($ev.params.density, 50e3)
#
#     dsp = density_spline_parameters()
#
#     @btime density_spline2($dsp,50e3)
#
# end
